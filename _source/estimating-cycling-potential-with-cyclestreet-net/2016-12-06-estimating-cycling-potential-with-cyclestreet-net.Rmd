---
layout: post
title:  Estimating cycling potential with CycleStreet.net
date: "`r Sys.time()`"
published: true
tags: [example1, example2]
bibliography: ~/repos/foss4t/references.bib
---

Today was released the [paper](https://www.jtlu.org/index.php/jtlu/article/view/862/824) that describes the Propensity to Cycle Tool (PCT) and some of the thinking behind it [@lovelace_propensity_2016]. For those new to the PCT, it's an online tool for helping to decide where to prioritise cycling policies such as new cycle paths.

## Introduction

The PCT has been 2 years in the making and there are many things to say about the it, from the methods that underly the estimates of cycling uptake to evidence-based policy. This post focusses on just one aspect of the PCT, however: its use of **CycleStreets.net** to convert straight travel desire lines into wiggly paths on the road network. These wiggly lines, such as those illustrated below (from [Figure 9 in the paper](https://www.jtlu.org/index.php/jtlu/article/view/862)), represent routes that someone cycling could plausibly take.

![](https://github.com/npct/pct/blob/master/flow-model/man-trinity-way.png?raw=true)

## Origin-destination (OD) data

Before saying something about the routes themselves it's worth taking a step back to look at the underlying data behind the PCT. The PCT relies on orgin-destination (OD) data. That is simply data in the following form:

```{r, echo=FALSE}
od_eg = tibble::frame_data(
  ~origin, ~destination, ~V1, ~V2,
  1, 2, 100, 3,
  1, 3, 50, 5
  )
knitr::kable(od_eg)
```

What this example OD table means is that 100 units of 'V1' and 3 units of V2 travel between zone 1 and zone 2. There is also movement represented between Zone 2 and 3.

Now, imagine that V1 represents the total number of people travelling between the origin and destination and that V2 represents the number who regularly cycle. That is the basic input dataset that we are using as an input into the PCT. We use 2011 OD data on travel to work, because that is the most comprehensive dataset on travel patterns available. (Note: we are using open data made available from the http://wicid.ukdataservice.ac.uk/ website).

## Converting OD data to desire lines with R

One problem with OD data is that the rows do not tend to have geography inherently built in. They could contain a variables called `lat_origin`, `lon_origin`, `lat_destination` and `lon_destination`. But generally they only contain the IDs of geographic zones. Therefore work is needed to convert the OD data into desire lines. Desire lines are straight lines representing where people would go if they were not constrained by the route network, as illustrated in Figure 3 of the [paper](https://www.jtlu.org/index.php/jtlu/article/view/862):

![](https://github.com/npct/pct/blob/master/flow-model/od-data-leeds.png?raw=true)

To do this work an R package was developed called **stplanr**. After [R and RStudio have been installed on your computer](https://bookdown.org/csgillespie/efficientR/set-up.html#r-version), this software can be installed from [CRAN](https://cran.r-project.org/) with the following command:

```{r, eval=FALSE}
install.packages("stplanr")
```

Once it is installed, the package can be loaded as follows (note that it depends on the **sp** package):

```{r}
library(stplanr)
```

This gives you access to many functions for working with transport data, with a focus on geographical data. It also provides example data from with desire lines, and eventually routes generated by CycleStreets.net can be generated. Let's take a look at some real OD data provided by **stplanr**:

```{r}
data("flow") # load the 'flow' dataset from the stplanr package
head(flow[c(1:3, 12)])
```

This shows that, between zone E02002361 and E02002361 (i.e. intrazonal flow) there were 109 people travelling to work by all modes in the 2011 census. 2 of them cycled. The equivalent numbers for the OD pair E02002361 to E02002371 were 44 and 3. But how to make this data geographical?

For that we need another dataset, also provided by **stplanr** as follows:

```{r}
data("cents") # load the 'cents' dataset
head(cents)
```

What's interesting about this `cents` dataset is that it's *geographical*, and can be plotted on the map without issue, as illustrated below:

```{r}
library(tmap)
osm_tiles = read_osm(bb(cents, 1.3))
(map = qtm(osm_tiles) +
  qtm(cents, symbols.size = 5) )
```

The **stplanr** R package enables linking the non-geographical flow data in the `flow` data frame with the geographical data plotted above and contained in the `cents` data object. Let's take a single OD pair, E02002361 to E02002371, the fourth row represented in the table above, to see how this works:

```{r}
flow_single_line = flow[4,] # select only the first line
desire_line_single = od2line(flow = flow_single_line, zones = cents)
```

Now we can plot this on the map as follows:






## References
