---
layout: post
title: 'Learning about classes in R with plot.bike()'
categories:
 - R
tags:
 - reviews
---

<p>A useful feature of R is its ability to implement a function differently depending on the ‘class’ of the object acted on. This article explores this behaviour with reference to a playful modification of the ‘generic’ function <code>plot()</code> to allow plotting of cartoon bicycles. Although the example is quite simple and fun, the concepts it touches on are complex and serious.</p>
<p>The example demonstrates several of the programming language paradigms that R operates under. R is simultaneously object-orientated, functional and polymorphic. The example also demonstrates the paradigm of inheritance, through the passing of arguments from <code>plot.bike()</code> to <code>plot()</code> via the <code>...</code> symbol. There has been much written about programming paradigms and R’s adherence to (or flouting of!) them. Two useful references on the subject are a <a href="http://en.wikibooks.org/wiki/C%2B%2B_Programming/Programming_Languages/Paradigms">Wikibook page on programming language paradigms</a> and Hadley Wickham's <a href="http://adv-r.had.co.nz/">Advanced R book</a>. There is a huge amount of information on these topics. For the purposes of the examples presented here suffice to say that R uses multiple paradigms and is extremely flexible.</p>

<!--more-->

<h2>Context: an advanced R course</h2>
<p>The behaviour of ‘generic functions’ such as <code>plot</code> was taught during a <a href="http://www.ncl.ac.uk/maths/rcourse/">2 day course</a> by Colin Gillespie in Newcastle. In it we learned about some of the nuts and bolts that underlie R’s uniquely flexible and sometimes bizarre syntax. Environments, start-up, functions and classes were some of the topics covered. These and more issues are described in multiple places on-line and in R’s own documentation, and neatly synthesised in Hadley Wickham’s penultimate book, Advanced R. However, nothing beats face-to-face learning and I learned plenty about R’s innards during the course, despite having read around the topics covered previously.</p>
<p>Colin has made his materials available on-line on github for the benefit of people worldwide. <a href="http://rcourses.github.io/" class="uri">http://rcourses.github.io/</a> contains links to pages which introduce a number of courses which can, to a large extent, be conducted from the safety of one’s home. There are also R packages for each of the courses. The package for the Advanced R course, for example, can be installed with the following code:</p>

<script src="https://gist.github.com/Robinlovelace/31dd620136b195ab2408.js"></script>

<p>Once the package has been installed and loaded, with <code>library(nclRadvanced)</code>, a number of vignettes and solutions sheets can be accessed, e.g. via:</p>
<pre class="r"><code>vignette(package = &quot;nclRadvanced&quot;)
vignette(package = &quot;nclRadvanced&quot;, &quot;practical2&quot;)</code></pre>
<h2>Creating a new S3 class for bikes</h2>
<p>The S3 class system is very flexible. Any object can be allocated to a class of any name, without restriction. S3 classes only become meaningful when objects allocated to particular class are passed to a function that recognises classes. Functions that behave differently depending on the class of the object they act on are known as generic.</p>
<p>We can find out the class type of an object using the <strong>pryr</strong> package. A good example of the S3 object type is “lm”, which plots in a different way thanks to <code>plot.lm()</code>, which dispatches the <code>plot()</code> command differently for objects within the <code>lm</code> S3 object class.</p>
<pre class="r"><code>x &lt;- 1:9
y &lt;- x^2
m &lt;- lm(y ~ x)
class(m)</code></pre>
<pre><code>## [1] &quot;lm&quot;</code></pre>
<pre class="r"><code>pryr::otype(m) # requires pryr to be installed</code></pre>
<pre><code>## [1] &quot;S3&quot;</code></pre>
<p>Note that the object system is flexible, so any class name can be allocated to any object, such as <code>class(x) &lt;- &quot;lm&quot;</code>. Note that if we enter this, <code>plot(x)</code> will try to dispatch <code>x</code> to <code>plot.lm()</code> and fail.</p>
<p>Classes only become useful when they have a series of generic methods associated with them. We will illustrate this by defining a list as a ‘bike’ object and creating a <code>plot.bike()</code>, a class-specific method of the generic plot function for plotting S3 objects of that class. Let’s define the key components of a bike:</p>

<script src="https://gist.github.com/Robinlovelace/56a32cdd7718db1ae48d.js"></script>

<p>Not that there are no strict rules. We could allocate the class to any object, and we could replace <code>bike</code> with almost any name. The S4 class, used in spatial data for example, is much stricter.</p>
<p>The bike class becomes useful when it comes to method dispatch, such as plotting.</p>
<h2>Creating a plot method for bikes</h2>
<p>Suppose that every <code>bike</code> object has the same as those contained in the object <code>x</code> created above. We can specify how it should be plotted as follows:</p>

<script src="https://gist.github.com/Robinlovelace/609227d083357408fbda.js"></script>

<p>Now that a new method has been added to the generic <code>plot()</code> function, the fun begins. Any object assigned to the class ‘bike’ will now automatically be dispatched to <code>plot.bike()</code> when <code>plot()</code> is called.</p>
<p>And, as the plots below show, a plot of a bicycle is produced.</p>
<pre class="r"><code>plot(x)</code></pre>
<p><img src="http://robinlovelace.net/figure/figure-html/unnamed-chunk-6-1.png" title alt width="672" /></p>
<p>Try playing with the wheel size - some bikes with quite strange dimensions can be produced!</p>
<pre class="r"><code>x$ws &lt;- 1500 # a bike with large wheels
plot(x)</code></pre>
<p><img src="http://robinlovelace.net/figure/figure-html/unnamed-chunk-7-1.png" title alt width="672" /></p>
<pre class="r"><code>x$ws &lt;- 150 # a bike with small wheels
plot(x)</code></pre>
<p><img src="http://robinlovelace.net/figure/figure-html/unnamed-chunk-8-1.png" title alt width="672" /></p>
<p>It would be interesting to see how the dimensions of the last bicycle compare with a <a href="http://en.wikipedia.org/wiki/Brompton_Bicycle">Brompton</a>!</p>

<h2>Discussion</h2>
<p>The bike class demonstrates that the power of S3 classes lies not in the class’s object but in the generic functions which take-on new methods. It is precisely this behaviour which makes the class family of <code>Spatial*</code> objects defined by the <strong>sp</strong> package so powerful. <strong>sp</strong> adds new methods for <code>plot()</code>, <code>aggregate()</code> and even the subsetting function <code>&quot;[&quot;</code>.</p>
<p>This can be seen by calling <code>methods()</code> before and after <strong>sp</strong> is loaded:</p>
<pre class="r"><code>methods(aggregate)</code></pre>
<pre><code>## [1] aggregate.data.frame aggregate.default*   aggregate.formula*
## [4] aggregate.ts
## see '?methods' for accessing help and source code</code></pre>
<pre class="r"><code>library(sp) # load the sp library, which creates new methods
methods(aggregate) # the new method is now shown</code></pre>
<pre><code>## [1] aggregate.data.frame aggregate.default*   aggregate.formula*
## [4] aggregate.Spatial*   aggregate.ts
## see '?methods' for accessing help and source code</code></pre>
<p>Note that <code>Spatial</code> classes are different from the <code>bike</code> class because they use the <code>S4</code> class system. We will be covering the nature and behaviour of <code>Spatial</code> objects in the “Spatial data analysis with R” course in Newcastle, 2nd - 3rd June, which is still <a href="http://www.ncl.ac.uk/maths/rcourse/#dates">open for registration</a>.</p>
<p>The <code>bike</code> class is not ‘production’ ready but there is no reason why someone <a href="http://sheldonbrown.com/">who understands bicycles inside out</a> could not create a well-defined (perhaps S4) class for a bicycle, with all the <a href="http://www.bikecad.ca/taxonomy/term/25">essential dimensions</a> defined. This could really be useful, including in efforts at making R more useful for transport planning, such as my package under development to provide tools for transportation research and analysis, <a href="https://github.com/Robinlovelace/stplanr">stplanr</a>.</p>
<p>Having learned about classes, I’m wondering whether origin-destination ‘flow’ data, used in <strong>stplanr</strong>, would benefit from its own class, or if its current definition as <code>SpatialLinesDataFrame</code> is sufficient. Any ideas welcome!</p>
<h2>Conclusion</h2>
<p>Classes are an advanced topic in R the usually just ‘work’. However, if you want to modify existing functions to behave differently on new object-types, understanding how to create classes and class-specific methods can be very useful. The example of the <code>bike</code> class created above is not intended for production, but provides a glimpse into what is possible. At the very least, this article should help provide readers with new insight into the inner workings of R and its impressive functional flexibility.</p>
<h2>Post script</h2>
<p>If you are interested in using R for transport research, please check out my under-development package <strong>stplanr</strong> and let me know via GitHub of any features you’d like it to have before submission to CRAN and <a href="https://ropensci.org/">rOpenSci</a>:</p>
<p><a href="https://github.com/Robinlovelace/stplanr" class="uri">https://github.com/Robinlovelace/stplanr</a></p>

<p>Or tweet me on <a href="https://twitter.com/robinlovelace">@robinlovelace</a></p>

